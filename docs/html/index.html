<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SPU: Assembly-type code translator and SPU-executor</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Assembly-type code translator and SPU-executor </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Show code<a class="anchor" id="md_README"></a> <a href="https://app.codacy.com/gh/AlexRoar/SPUAsm?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=AlexRoar/SPUAsm&amp;utm_campaign=Badge_Grade"><img src="https://api.codacy.com/project/badge/Grade/0ef56e0968ad4689a264716b9becbd09" alt="Codacy Badge" class="inline"/></a> <a href="https://www.codefactor.io/repository/github/alexroar/spuasm"><img src="https://www.codefactor.io/repository/github/alexroar/spuasm/badge" alt="CodeFactor" class="inline"/></a></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Description</h1>
<p>This project implements code translation to uneven bytecode, disassembly tool for generated bytecode, and bytecode executor (Soft Processor Unit).</p>
<p>In addition, I implemented code analyser that checks for syntax mistakes. Analyser outputs info in clang format, so most IDEs highlight wrong expressions and provide descriptions of errors as well as possible solutions when possible.</p>
<p><img src="https://github.com/AlexRoar/SPUAsm/raw/main/Images/errors.png" alt="" style="max-height: 100px" class="inline"/></p>
<p>During the translation, .lst file is generated. It provides information about bytecode generation and what command at what offset is located.</p>
<p><img src="https://github.com/AlexRoar/SPUAsm/raw/main/Images/generalview.png" alt="" style="max-height: 250px" class="inline"/></p>
<p><a href="https://alexroar.github.io/SPUAsm/html/"><b>Documentation</b></a></p>
<h1><a class="anchor" id="autotoc_md2"></a>
Installation</h1>
<p>Enter project's directory and execute:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line">cmake --build .</div>
</div><!-- fragment --><p>Three files will be created:</p><ul>
<li><b>SPU</b> - Soft Processor Unit, executes created programs</li>
<li><b>SPUAsm</b> - translates source file (.spus) to binary file (.spub) that can be executed by SPU</li>
<li><b>SPUDisAsm</b> - disassembly for generated binary files</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Usage</h1>
<p><b>SPUAsm</b> </p><div class="fragment"><div class="line">$ SPUAsm &lt;source file&gt;</div>
<div class="line">        --input &lt;filename.spus&gt;     - source file (can be specified without --input)</div>
<div class="line">        --output &lt;filename.spub&gt;    - binary assembled file</div>
<div class="line">        -E                          - generate preprocessed file</div>
<div class="line">        --verbose                   - output assembly debug information</div>
<div class="line">        --lst &lt;filename.lst&gt;        - listing file of generated code (assembly.lst by default) </div>
<div class="line">        -h, --help                  - show help message</div>
</div><!-- fragment --><p><b>SPUDisAsm</b> </p><div class="fragment"><div class="line">$ SPUDisAsm &lt;binary file&gt;</div>
<div class="line">        --input &lt;filename.spub&gt;     - binary assembled file</div>
<div class="line">        --output &lt;filename.spus&gt;    - source file (if not specified, stdout selected)</div>
<div class="line">        --verbose                   - output assembly debug information</div>
<div class="line">        -h, --help                  - show help message</div>
</div><!-- fragment --><p><b>SPU</b> </p><div class="fragment"><div class="line">$ SPU &lt;binary file&gt;</div>
<div class="line">        --input &lt;filename.spub&gt;     - binary assembled file</div>
<div class="line">        --output &lt;filename.spus&gt;    - source file (if not specified, stdout selected)</div>
<div class="line">        --verbose                   - output assembly debug information</div>
<div class="line">        --vsync                     - render vram after every command</div>
<div class="line">        -h, --help                  - show help message</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Examples</h1>
<p>All examples are available <a href="https://github.com/AlexRoar/SPUAsm/tree/main/Examples/SPUAsm/SPUAsm">in this dir</a>.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Squares of first n numbers</h2>
<p>&lt;details&gt;</p>
<div class="fragment"><div class="line">;</div>
<div class="line">; Squares</div>
<div class="line">;</div>
<div class="line"> </div>
<div class="line">in rbx  ; rbx as counter</div>
<div class="line"> </div>
<div class="line">push 0</div>
<div class="line">pop rax</div>
<div class="line"> </div>
<div class="line">loop:</div>
<div class="line">dec rbx  ; decrease counter</div>
<div class="line"> </div>
<div class="line">; Calculating square</div>
<div class="line">push rax</div>
<div class="line">push rax</div>
<div class="line">mul</div>
<div class="line">out</div>
<div class="line"> </div>
<div class="line">; Prepare for the next loop</div>
<div class="line">pop</div>
<div class="line">inc rax</div>
<div class="line"> </div>
<div class="line">jm mondayOnly ; exit if it is monday</div>
<div class="line"> </div>
<div class="line">; Insert conditional jump operands</div>
<div class="line">push 0</div>
<div class="line">push rbx</div>
<div class="line"> </div>
<div class="line">jne loop</div>
<div class="line"> </div>
<div class="line">mondayOnly:</div>
</div><!-- fragment --><p>&lt;/details&gt;</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Popping circles</h2>
<p><img src="https://github.com/AlexRoar/SPUAsm/raw/main/Images/circles.gif" alt="" style="max-height: 100px" class="inline"/></p>
<p>&lt;details&gt;</p>
<p>Show code </p>
<div class="fragment"><div class="line">; height 32</div>
<div class="line">; width  64</div>
<div class="line"> </div>
<div class="line">push 32</div>
<div class="line">push 16</div>
<div class="line">push 10</div>
<div class="line">push 35</div>
<div class="line">call drawCircle</div>
<div class="line"> </div>
<div class="line">clrscr</div>
<div class="line"> </div>
<div class="line">push 32</div>
<div class="line">push 16</div>
<div class="line">push 4</div>
<div class="line">push 42</div>
<div class="line">call drawCircle</div>
<div class="line"> </div>
<div class="line">clrscr</div>
<div class="line"> </div>
<div class="line">push 16</div>
<div class="line">push 8</div>
<div class="line">push 2</div>
<div class="line">push 42</div>
<div class="line">call drawCircle</div>
<div class="line"> </div>
<div class="line">clrscr</div>
<div class="line">rend</div>
<div class="line"> </div>
<div class="line">push 40</div>
<div class="line">push 25</div>
<div class="line">push 4</div>
<div class="line">push 48</div>
<div class="line">call drawCircle</div>
<div class="line"> </div>
<div class="line">clrscr</div>
<div class="line">rend</div>
<div class="line"> </div>
<div class="line">push 60</div>
<div class="line">push 13</div>
<div class="line">push 8</div>
<div class="line">push 48</div>
<div class="line">call drawCircle</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">hlt</div>
<div class="line"> </div>
<div class="line">drawCircle: ;(x0, y0, r, symbol)</div>
<div class="line">    pop [2]</div>
<div class="line">    pop rcx  ; r</div>
<div class="line">    pop rbx  ; y0</div>
<div class="line">    pop rax  ; x0</div>
<div class="line"> </div>
<div class="line">    mov rdx 0   ; initial angle</div>
<div class="line">    loop:</div>
<div class="line">        push rbx</div>
<div class="line">        push rdx</div>
<div class="line">        sin</div>
<div class="line">        push rcx</div>
<div class="line">        mul</div>
<div class="line">        add ; y0 + r*sin(alpha)</div>
<div class="line"> </div>
<div class="line">        pop [0] ; y coordinate</div>
<div class="line"> </div>
<div class="line">        push rax</div>
<div class="line">        push rdx</div>
<div class="line">        cos</div>
<div class="line">        push rcx</div>
<div class="line">        push 2</div>
<div class="line">        mul</div>
<div class="line">        mul</div>
<div class="line">        add ; x0 + r*cos(alpha)</div>
<div class="line"> </div>
<div class="line">        pop [1] ; x coordinate</div>
<div class="line"> </div>
<div class="line">        pixset [1] [0] [2]</div>
<div class="line">        </div>
<div class="line">        rend</div>
<div class="line">        slp 10000</div>
<div class="line">    ; loop params</div>
<div class="line">    mov rdx rdx+0.1</div>
<div class="line">    push rdx</div>
<div class="line">    push 3.1415926535897</div>
<div class="line">    push 2</div>
<div class="line">    mul</div>
<div class="line">    jbe loop</div>
<div class="line">    ret</div>
</div><!-- fragment --><p>&lt;/details&gt;</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Square equation solutions</h2>
<p>&lt;details&gt;</p>
<p>Show code </p>
<div class="fragment"><div class="line">;</div>
<div class="line">; Data input</div>
<div class="line">; (a, b, c)</div>
<div class="line">;</div>
<div class="line">in      rax</div>
<div class="line">in      rbx</div>
<div class="line">in      rcx</div>
<div class="line"> </div>
<div class="line">;</div>
<div class="line">; D calculation</div>
<div class="line">;</div>
<div class="line">push    rbx</div>
<div class="line">push    2</div>
<div class="line">pow</div>
<div class="line"> </div>
<div class="line">push    4</div>
<div class="line">push    rax</div>
<div class="line">mul</div>
<div class="line">push    rcx</div>
<div class="line">mul</div>
<div class="line">sub</div>
<div class="line">sqrt</div>
<div class="line">pop     rdx</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">;</div>
<div class="line">; First x</div>
<div class="line">;</div>
<div class="line">clear</div>
<div class="line">push    -1</div>
<div class="line">push    rbx</div>
<div class="line">mul</div>
<div class="line">push    rdx</div>
<div class="line">sub</div>
<div class="line">push    2</div>
<div class="line">div</div>
<div class="line">push    rax</div>
<div class="line">div</div>
<div class="line">pop     rcx</div>
<div class="line"> </div>
<div class="line">;</div>
<div class="line">; Second x</div>
<div class="line">;</div>
<div class="line">clear</div>
<div class="line">push    -1</div>
<div class="line">push    rbx</div>
<div class="line">mul</div>
<div class="line">push    rdx</div>
<div class="line">add</div>
<div class="line">push    2</div>
<div class="line">div</div>
<div class="line">push    rax</div>
<div class="line">div</div>
<div class="line">pop     rax</div>
<div class="line"> </div>
<div class="line">;</div>
<div class="line">; Output</div>
<div class="line">;</div>
<div class="line">out     rax</div>
<div class="line">out     rcx</div>
</div><!-- fragment --><p>&lt;/details&gt;</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Algorithm description</h1>
<p>Binary generation can be splitted into several parts:</p>
<ul>
<li>Cleanup</li>
<li>Analysis</li>
<li>Final cleanup</li>
<li>Translation</li>
<li>Final checks</li>
</ul>
<p>If process fails on any part, the next parts are not executed.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Cleanup</h3>
<p>Just double whitespaces, trailing/leading whitespaces removed. Operations that does not change code structure, lines number etc.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Analysis</h3>
<p>Analyses code for syntax errors, builds temporary code to calculate labels offsets. Prints errors descriptions in clang format.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Final cleanup</h3>
<p>All unnecessary indent symbols removed (comments, blank lines, unneded whitespaces). Code structure will be altered, line numbers are not preserved.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
Translation</h3>
<p>Code is translated using labels table generated on analysis step. At this point, all errors must be catched by analysis, but still some can make thir way to this point. In this case, generation will fail, dumping wrong instruction and its number.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Final checks</h3>
<p>Check that all operations completed correctly; labels table is complete and not redundant.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Syntax</h1>
<h2><a class="anchor" id="autotoc_md15"></a>
Complex value (cvalue)</h2>
<p>Operators with arguments accept <em>complex value</em> argument. Argument can be <b>assignable</b> or <b>not assignable</b></p>
<p>Complex value examples:</p><ul>
<li>[rax+5] - assignable, RAM on adress rax+5 with double adressation</li>
<li>4 - not assignable, immediate value 4</li>
<li>[5] - assignable, RAM on adress 5 with double adressation</li>
<li>[rcx] - assignable, RAM on adress rcx with double adressation</li>
<li>rcx - assignable, register rcx</li>
<li>(rcx) - assignable, RAM on adress rcx with <b>char</b> adressation</li>
<li>(rcx+10) - assignable, RAM on adress rcx+10 with <b>char</b> adressation</li>
<li>(10) - assignable, RAM on adress 10 with <b>char</b> adressation</li>
</ul>
<p><b>Notice:</b> whitespaces inside complex value are not allowed and considered as syntax error.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
General purpose</h2>
<h3><a class="anchor" id="autotoc_md17"></a>
push &lt;any cvalue&gt;</h3>
<p>Push value to the stack</p>
<h3><a class="anchor" id="autotoc_md18"></a>
pop &lt;nothing/assignable cvalue&gt;</h3>
<p>Pop value from the stack</p><ul>
<li>no args - just delete</li>
<li>cvalue - pop and save to assignable cvalue</li>
</ul>
<h3><a class="anchor" id="autotoc_md19"></a>
in &lt;nothing/assignable cvalue&gt;</h3>
<p>Request value from the console</p><ul>
<li>no args - push value to the stack</li>
<li>cvalue - save to assignable cvalue</li>
</ul>
<h3><a class="anchor" id="autotoc_md20"></a>
out &lt;nothing/any cvalue&gt;</h3>
<p>Prints value to the console</p><ul>
<li>no args - last stack value</li>
<li>cvalue - cvalue value</li>
</ul>
<h3><a class="anchor" id="autotoc_md21"></a>
mov &lt;assignable cvalue&gt;  &lt;any cvalue&gt;</h3>
<p>destination -&gt; source</p>
<p>Sets the first argument value to the secon argument's value</p>
<h3><a class="anchor" id="autotoc_md22"></a>
dump</h3>
<p>Dump stack information</p>
<h3><a class="anchor" id="autotoc_md23"></a>
clear</h3>
<p>Clear stack</p>
<h3><a class="anchor" id="autotoc_md24"></a>
rend</h3>
<p>Force render vram</p>
<h3><a class="anchor" id="autotoc_md25"></a>
slp      &lt;any cvalue&gt;</h3>
<p>Sleep for ... nanoseconds</p>
<h3><a class="anchor" id="autotoc_md26"></a>
hlt</h3>
<p>Finish the program</p>
<h3><a class="anchor" id="autotoc_md27"></a>
pixelset &lt;any cvalue&gt; &lt;any cvalue&gt; &lt;any cvalue&gt;</h3>
<p>x y value</p>
<p>Set vram pixel (x, y) to value</p>
<h3><a class="anchor" id="autotoc_md28"></a>
clrscr</h3>
<p>Fill vram with spaces</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Math</h2>
<h3><a class="anchor" id="autotoc_md30"></a>
inc &lt;nothing/assignable cvalue&gt;</h3>
<p>Increments the value</p><ul>
<li>no args - last stack value</li>
<li>cvalue - cvalue value</li>
</ul>
<h3><a class="anchor" id="autotoc_md31"></a>
dec &lt;nothing/assignable cvalue&gt;</h3>
<p>Decrements the value</p><ul>
<li>no args - last stack value</li>
<li>cvalue - cvalue value</li>
</ul>
<h3><a class="anchor" id="autotoc_md32"></a>
add</h3>
<p>Add two last stack values and push to the stack</p>
<h3><a class="anchor" id="autotoc_md33"></a>
sub</h3>
<p>Substract two last stack values and push to the stack</p>
<h3><a class="anchor" id="autotoc_md34"></a>
mul</h3>
<p>Multiply two last stack values and push to the stack</p>
<h3><a class="anchor" id="autotoc_md35"></a>
div</h3>
<p>Divide two last stack values and push to the stack</p>
<h3><a class="anchor" id="autotoc_md36"></a>
sin</h3>
<p>Sin of the last stack value</p>
<h3><a class="anchor" id="autotoc_md37"></a>
cos</h3>
<p>Cos of the last stack value</p>
<h3><a class="anchor" id="autotoc_md38"></a>
abs</h3>
<p>Abs of the last stack value</p>
<h3><a class="anchor" id="autotoc_md39"></a>
sqrt</h3>
<p>Square root of the last stack value</p>
<h3><a class="anchor" id="autotoc_md40"></a>
pow</h3>
<p>The pre-last element of the stack to the power of the last one</p>
<h2><a class="anchor" id="autotoc_md41"></a>
Codeflow modifiers</h2>
<h3><a class="anchor" id="autotoc_md42"></a>
call &lt;label&gt;</h3>
<p>Gives execution to the label block. Can be returned to the call instruction using <em>ret</em></p>
<h3><a class="anchor" id="autotoc_md43"></a>
ret</h3>
<p>Returnes to the last call position. May fail if there were no calls.</p>
<h3><a class="anchor" id="autotoc_md44"></a>
jmp &lt;label&gt;</h3>
<p>Jump to the label</p>
<h3><a class="anchor" id="autotoc_md45"></a>
jb &lt;label&gt;</h3>
<p>Jump if last element is bigger than pre-last. Removes both operands from the stack</p>
<h3><a class="anchor" id="autotoc_md46"></a>
jbe &lt;label&gt;</h3>
<p>Jump if last element is bigger-or-equal than pre-last. Removes both operands from the stack</p>
<h3><a class="anchor" id="autotoc_md47"></a>
je &lt;label&gt;</h3>
<p>Jump if last element is equal to the pre-last one. Removes both operands from the stack</p>
<h3><a class="anchor" id="autotoc_md48"></a>
jne &lt;label&gt;</h3>
<p>Jump if last element is not equal to the pre-last one. Removes both operands from the stack</p>
<h3><a class="anchor" id="autotoc_md49"></a>
ja &lt;label&gt;</h3>
<p>Jump if last element is lower than pre-last. Removes both operands from the stack</p>
<h3><a class="anchor" id="autotoc_md50"></a>
jae &lt;label&gt;</h3>
<p>Jump if last element is lower-or-equal than pre-last. Removes both operands from the stack</p>
<h3><a class="anchor" id="autotoc_md51"></a>
jm &lt;label&gt;</h3>
<p>Jump if it's Monday.</p>
<h3><a class="anchor" id="autotoc_md52"></a>
labelName:</h3>
<p>Creates label</p>
<h1><a class="anchor" id="autotoc_md53"></a>
Links</h1>
<ul>
<li><a href="https://github.com/AlexRoar/SPUAsm/blob/main/SoftProcessorUnit/Assembly/SPUAssembly.cpp">SPUAsm code</a></li>
<li><a href="https://github.com/AlexRoar/SPUAsm/blob/main/SoftProcessorUnit/Disassembly/SPUDisAssembly.cpp">SPUDisAsm code</a></li>
<li><a href="https://github.com/AlexRoar/SPUAsm/blob/main/SoftProcessorUnit/SPU/SPU.cpp">SPU code</a></li>
<li><a href="https://github.com/AlexRoar/SPUAsm/tree/main/Examples/SPUAsm/SPUAsm">Examples</a> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
